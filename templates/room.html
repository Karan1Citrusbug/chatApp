<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <title>Chat Room</title>
</head>

<body>
    <div class="d-flex justify-content-center align-items-center vh-100">
        <div>
            <div class="p-2">
                <a href=""></a>
                <!-- <textarea id="chatarea" type="text" rows="10" cols="50" readonly></textarea> -->
                <div id="chatarea" style="float: left; width: 600px; overflow-y: auto; height: 500px"></div>
            </div>
            <div class="p-2">
                <div id="status"></div>
                <input type="text" id="chatinput" placeholder="Enter message" />
                <input type="file" id="chatimginput" />
                <input id="chatbtn" type="button" value="submit" />
            </div>
        </div>
    </div>

    <script>
        function scrollToBottom() {
            var objDiv = document.getElementById("chatarea");
            objDiv.scrollTop = objDiv.scrollHeight;
        }
        
        var btn = document.getElementById("chatbtn");
        const data = {{ data|safe }};
        const room_name = "{{ room_name }}";
        const user = "{{ user }}";

        let formattedText = '';
        var deleteUrl = "{% url 'delete' 0 %}";
        data.forEach(item => {
            var editurl = deleteUrl.replace(0, item.id);
            if (item.user === user) {
                if(item.message == "deleted"){
                    formattedText += `<div>You deleted this message</div>`;
                }else{
                    if (item.chatimg) {
                    formattedText += `<div>You : <img src="${item.chatimg}" style="max-width: 100%; max-height: 400px;" alt="chat img" />`;
                    formattedText += `<a href="${editurl}" onclick="return confirmDelete();"><i class="fas fa-trash text-danger"></i></a></div>`;
                    } else{
                    formattedText += `<div>You: ${item.message}`;
                    formattedText += `<a href="${editurl}" onclick="return confirmDelete();"><i class="fas fa-trash text-danger"></i></a></a></div>`;
                    }
                }
            } else {
                if(item.message == "deleted"){
                    formattedText += `<div>${item.user} deleted this message</div>`;
                }else{
                    if (item.chatimg) {
                    formattedText += `<div>${item.user} : <img src="${item.chatimg}" style="max-width: 100%; max-height: 400px;" alt="chat img" />`;
                    } else{
                        formattedText += `<div>${item.user}: ${item.message}`;
                    }   
                }
            }
            formattedText += `<br>`;
        });
        function confirmDelete() {
            return confirm("Are you sure you want to delete this user?");
        }
        document.getElementById('chatarea').innerHTML = formattedText;
        scrollToBottom();
        // create new web socket connection
        const chatSocket = new WebSocket(
            `ws://${window.location.host}/ws/chat/${room_name}/`
        );

        // check if have some message chat already present if yes list them
        chatSocket.onmessage = function (e) {
            const msg = JSON.parse(e.data);
            const chatArea = document.querySelector("#chatarea");
            if (msg.message != null){
                if(user == msg.user){
                    chatArea.innerHTML += `<div>("You" + ":" + ${msg.message} + '\n')</div>`;
                }else{
                    chatArea.innerHTML += `<div>(${msg.user} + ":" + ${msg.message} + '\n')</div>`;
                }
            }else if(msg.chatimg != null){
                if(user == msg.user){
                    chatArea.innerHTML += `<div>You : <img src="${msg.chatimg}" style="max-width: 100%; max-height: 400px;" alt="chat img" /></div><br>`;;
                }else{
                    chatArea.innerHTML += `<div>${msg.user} : <img src="${msg.chatimg}" style="max-width: 100%; max-height: 400px;" alt="chat img" /></div><br>`;
                }
            }
            let typingTimer;
            const typingInterval = 500;
            const statusDiv = document.getElementById('status');
            if (msg.status) {
                if (msg.user != user) {
                    statusDiv.textContent = msg.user + ' typing...';
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => {
                        statusDiv.textContent = '';
                    }, typingInterval);
                }
            } else {
                inputField = document.getElementById("chatinput");
                inputField.addEventListener('blur', () => {
                    clearTimeout(typingTimer);
                    statusDiv.textContent = '';
                });
            }
        }

        // send status for typing
        document.querySelector('#chatinput').focus();
        document.querySelector('#chatinput').oninput = function () {
            chatSocket.send(JSON.stringify({
                'user': user,
                'status': true
            }));
        };

        document.querySelector('#chatinput').onblur = function () {
            chatSocket.send(JSON.stringify({
                'user': user,
                'status': false
            }));
        };

        document.getElementById("chatbtn").onclick = function (e) {
            const msg = document.getElementById("chatinput").value;
            const chatimgInput = document.getElementById("chatimginput");
            const chatimg = chatimgInput.files[0];
            if (msg != "") {
                chatSocket.send(JSON.stringify({ 'message': msg, 'user': user, 'room_name': room_name }));
                document.querySelector("#chatinput").value = '';
            }
            if (chatimg) {
                const reader = new FileReader();
                reader.onloadend = function () {
                    const imgBase64 = reader.result; // Includes the format prefix
                    chatSocket.send(JSON.stringify({ 'chatimg': imgBase64, 'user': user, 'room_name': room_name }));
                    document.querySelector("#chatimginput").value = ''; // Clear file input
                };
                reader.readAsDataURL(chatimg); // Read the file as a data URL
            }
        };

        chatSocket.onclose = function (e) {
            console.log("chatsocket closed")
        };

        document.querySelector("#chatinput").focus();
        document.querySelector("#chatinput").onkeyup = function (e) {
            if (e.keyCode === 13) {  //press enter
                btn.click();
            }
        }
    </script>
</body>

</html>